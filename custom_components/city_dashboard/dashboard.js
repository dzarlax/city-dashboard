import I,{forwardRef as P,createElement as k,useState as x,useEffect as w,useMemo as A,useRef as W,useCallback as q,StrictMode as K}from"react";import V from"react-dom";var N={exports:{}},f={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var L;function z(){if(L)return f;L=1;var t=I,r=Symbol.for("react.element"),c=Symbol.for("react.fragment"),o=Object.prototype.hasOwnProperty,d=t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,i={key:!0,ref:!0,__self:!0,__source:!0};function n(a,s,m){var l,h={},p=null,u=null;m!==void 0&&(p=""+m),s.key!==void 0&&(p=""+s.key),s.ref!==void 0&&(u=s.ref);for(l in s)o.call(s,l)&&!i.hasOwnProperty(l)&&(h[l]=s[l]);if(a&&a.defaultProps)for(l in s=a.defaultProps,s)h[l]===void 0&&(h[l]=s[l]);return{$$typeof:r,type:a,key:p,ref:u,props:h,_owner:d.current}}return f.Fragment=c,f.jsx=n,f.jsxs=n,f}var M;function J(){return M||(M=1,N.exports=z()),N.exports}var e=J(),y={},C;function G(){if(C)return y;C=1;var t=V;return y.createRoot=t.createRoot,y.hydrateRoot=t.hydrateRoot,y}var Y=G();/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Z=t=>t.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),B=(...t)=>t.filter((r,c,o)=>!!r&&r.trim()!==""&&o.indexOf(r)===c).join(" ").trim();/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */var Q={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const X=P(({color:t="currentColor",size:r=24,strokeWidth:c=2,absoluteStrokeWidth:o,className:d="",children:i,iconNode:n,...a},s)=>k("svg",{ref:s,...Q,width:r,height:r,stroke:t,strokeWidth:o?Number(c)*24/Number(r):c,className:B("lucide",d),...a},[...n.map(([m,l])=>k(m,l)),...Array.isArray(i)?i:[i]]));/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const R=(t,r)=>{const c=P(({className:o,...d},i)=>k(X,{ref:i,iconNode:r,className:B(`lucide-${Z(t)}`,o),...d}));return c.displayName=`${t}`,c};/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ee=R("Bus",[["path",{d:"M8 6v6",key:"18i7km"}],["path",{d:"M15 6v6",key:"1sg6z9"}],["path",{d:"M2 12h19.6",key:"de5uta"}],["path",{d:"M18 18h3s.5-1.7.8-2.8c.1-.4.2-.8.2-1.2 0-.4-.1-.8-.2-1.2l-1.4-5C20.1 6.8 19.1 6 18 6H4a2 2 0 0 0-2 2v10h3",key:"1wwztk"}],["circle",{cx:"7",cy:"18",r:"2",key:"19iecd"}],["path",{d:"M9 18h5",key:"lrx6i"}],["circle",{cx:"16",cy:"18",r:"2",key:"1v4tcr"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const te=R("MapPin",[["path",{d:"M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0",key:"1r0f0z"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const se=R("Repeat2",[["path",{d:"m2 9 3-3 3 3",key:"1ltn5i"}],["path",{d:"M13 18H7a2 2 0 0 1-2-2V6",key:"1r6tfw"}],["path",{d:"m22 15-3 3-3-3",key:"4rnwn2"}],["path",{d:"M11 6h6a2 2 0 0 1 2 2v10",key:"2f72bc"}]]),re="https://transport-api.dzarlax.dev",F=(t,r=!1)=>{const c=new Date(t*1e3),o=c.getHours(),d=c.getMinutes(),i=o>=12?"PM":"AM",n=o%12||12;if(r)return`${n}${i}`;const a=d.toString().padStart(2,"0");return`${n}:${a}${i}`},ae=({lat:t,lon:r})=>{const[c,o]=x([]),[d,i]=x(!0),[n,a]=x(null),[s,m]=x(null);return w(()=>{(async()=>{var h;try{const p=await fetch(`${re}/api/env`);if(!p.ok)throw new Error("Failed to fetch API key");const u=await p.json();if(!((h=u.env)!=null&&h.WEATHER_API_KEY))throw new Error("API key not found");m(u.env.WEATHER_API_KEY)}catch(p){console.error("Error fetching API key:",p),a("Failed to load weather data")}})()},[]),w(()=>{if(!s)return;(async()=>{try{i(!0);const h=`https://api.openweathermap.org/data/2.5/forecast?lat=${t}&lon=${r}&units=metric&cnt=12&appid=${s}`,p=await fetch(h);if(!p.ok)throw new Error("Failed to fetch forecast");const u=await p.json();o(u.list.slice(0,12)),a(null)}catch(h){console.error("Error fetching forecast:",h),a("Unable to load forecast")}finally{i(!1)}})()},[t,r,s]),d?e.jsx("div",{className:"bg-white border border-gray-200 rounded-lg p-2 sm:p-3",children:e.jsx("div",{className:"h-24 flex items-center justify-center",children:e.jsx("p",{className:"text-sm text-gray-500",children:"Loading weather..."})})}):n?e.jsx("div",{className:"bg-white border border-gray-200 rounded-lg p-2 sm:p-3",children:e.jsx("div",{className:"h-24 flex items-center justify-center",children:e.jsx("p",{className:"text-sm text-red-500",children:n})})}):e.jsx("div",{className:"bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden",children:e.jsxs("div",{className:"p-2 sm:p-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-800",children:"Weather Forecast"}),e.jsxs("span",{className:"text-xs text-gray-500",children:["Next ",c.length," hours"]})]}),e.jsx("div",{className:"flex overflow-x-auto scrollbar-hide",children:e.jsx("div",{className:"flex gap-2 sm:gap-3 pb-1",children:c.map((l,h)=>e.jsxs("div",{className:"flex flex-col items-center justify-center min-w-[3.5rem] sm:min-w-[4.5rem]",children:[e.jsx("p",{className:"text-[10px] text-gray-500 mb-0.5 sm:hidden",children:F(l.dt,!0)}),e.jsx("p",{className:"text-xs text-gray-500 mb-0.5 hidden sm:block",children:F(l.dt,!1)}),e.jsx("img",{src:`https://openweathermap.org/img/wn/${l.weather[0].icon}.png`,alt:l.weather[0].description,className:"w-8 h-8 sm:w-10 sm:h-10",loading:"lazy"}),e.jsxs("p",{className:"text-xs sm:text-sm font-medium text-gray-800",children:[Math.round(l.main.temp),"°"]})]},h))})})]})})},U="https://transport-api.dzarlax.dev",ne=t=>`${Math.ceil(t/60)}min`,D=(t,r)=>t.secondsLeft!==r.secondsLeft||t.stationsBetween!==r.stationsBetween,oe=()=>e.jsx("div",{className:"flex justify-center items-center py-12",children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-12 h-12 rounded-full border-4 border-blue-100"}),e.jsx("div",{className:"absolute top-0 left-0 w-12 h-12 rounded-full border-4 border-blue-500 border-t-transparent animate-spin"})]})}),ie=I.memo(({name:t,distance:r,stopId:c,vehicles:o=[],city:d})=>{const i=A(()=>o.reduce((a,s)=>{const m=`${c}-${s.lineNumber}-${s.lineName||"unknown"}-${s.stationName||""}`;return a[m]||(a[m]={lineNumber:s.lineNumber,lineName:s.lineName,stationName:s.stationName,arrivals:[]}),a[m].arrivals.push({secondsLeft:s.secondsLeft,stationsBetween:s.stationsBetween,garageNo:s.garageNo}),a},{}),[o,c]),n=A(()=>Object.values(i).sort((a,s)=>parseInt(a.lineNumber)-parseInt(s.lineNumber)),[i]);return e.jsx("div",{className:"bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 overflow-hidden",children:e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ee,{className:"w-5 h-5 text-blue-500 opacity-70 group-hover:opacity-100 transition-opacity"}),e.jsxs("h3",{className:"text-base font-medium text-gray-800",children:[t," ",e.jsxs("span",{className:"text-gray-500 text-sm",children:["(# ",c,")"]})]})]}),e.jsx("span",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full",children:r})]}),n.length>0&&e.jsx("div",{className:"space-y-2 border-t border-gray-100 pt-2 mt-2",children:n.map((a,s)=>e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-baseline gap-2",children:[e.jsxs("span",{className:"flex-shrink-0 text-sm font-medium text-blue-600 bg-blue-50 px-2 py-0.5 rounded",children:[a.lineNumber," ",a.lineName?`- ${a.lineName}`:""]}),a.stationName&&e.jsxs("span",{className:"text-xs text-gray-500 truncate",children:["→ ",a.stationName]})]}),e.jsx("div",{className:"flex flex-wrap gap-2 pl-8 text-xs text-gray-500",children:a.arrivals.sort((m,l)=>m.secondsLeft-l.secondsLeft).map((m,l)=>e.jsxs("span",{className:"whitespace-nowrap",children:[ne(m.secondsLeft),m.stationsBetween>0&&` (${m.stationsBetween})`]},l))})]},s))})]})})},(t,r)=>t.vehicles.length!==r.vehicles.length?!1:t.vehicles.every((c,o)=>{const d=r.vehicles[o];return!D(c,d)})),ce=(t,r)=>{const[c,o]=x(new Map),[d,i]=x(!0),[n,a]=x(null),[s,m]=x(null),l=W(new Map),h=q(async()=>{if(!(!t||!r.searchRad))try{const p=["bg","ns","nis"];let u=!1;const $=new Map;await Promise.all(p.map(async g=>{const H=new URLSearchParams({lat:t.lat,lon:t.lon,rad:r.searchRad}),E=await fetch(`${U}/api/stations/${g}/all?${H.toString()}`);if(!E.ok)throw new Error(`Failed to fetch stations for ${g.toUpperCase()}`);(await E.json()).forEach(v=>{const b=`${v.stopId}-${g}`,j={...v,distance:`${Math.round(v.distance)}m`,city:g.toUpperCase()},_=l.current.get(b)||[];(!_.length||j.vehicles.some((O,T)=>{const S=_[T];return!S||D(S,O)}))&&(u=!0,l.current.set(b,[...j.vehicles])),$.set(b,j)})})),o($),u&&m(new Date),i(!1),a(null)}catch(p){a(p.message||"Failed to load stations"),i(!1)}},[t,r.searchRad]);return w(()=>{if(t){h();const p=setInterval(h,1e4);return()=>{clearInterval(p),l.current.clear()}}},[t,h]),{stops:Array.from(c.values()),loading:d,error:n,lastUpdated:s,refresh:h}},le=()=>{const[t,r]=x({userLocation:null,config:{lat:null,lon:null,searchRad:null},error:null});return w(()=>{(async()=>{let o=null,d=null,i=null;try{o=await getHomeAssistantConfig()}catch(n){console.warn("Failed to fetch Home Assistant config:",n)}try{const a=await(await fetch(`${U}/api/env`)).json();d={lat:parseFloat(a.env.BELGRADE_LAT),lon:parseFloat(a.env.BELGRADE_LON),searchRad:parseInt(a.env.SEARCH_RAD,10)}}catch(n){console.warn("Failed to fetch environment config:",n)}try{"geolocation"in navigator&&!window.location.pathname.includes("/local/city_dashboard/")&&(i=await new Promise((n,a)=>{navigator.geolocation.getCurrentPosition(s=>n({lat:s.coords.latitude,lon:s.coords.longitude}),s=>{console.warn("Geolocation error:",s),a(s)})}))}catch(n){console.warn("Failed to get browser location:",n)}r({config:d||{searchRad:1e3},userLocation:o?{lat:o.latitude,lon:o.longitude}:i?{lat:i.lat,lon:i.lon}:d,error:!d&&!o&&!i?"Failed to load configuration":null})})()},[]),t},de=()=>{const{userLocation:t,config:r,error:c}=le(),{stops:o,loading:d,error:i,lastUpdated:n,refresh:a}=ce(t,r);return c?e.jsx("div",{className:"text-center p-4 text-red-500",children:c}):t?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 p-2 sm:p-4 lg:p-6",children:e.jsxs("div",{className:"max-w-6xl mx-auto space-y-4 sm:space-y-6",children:[e.jsx("div",{className:"bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden",children:e.jsxs("div",{className:"p-3 sm:p-4 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[e.jsx("div",{className:"bg-blue-50 p-2 rounded-lg",children:e.jsx(te,{className:"w-4 h-4 sm:w-5 sm:h-5 text-blue-500"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg sm:text-xl font-semibold text-gray-800 leading-tight",children:"Nearby Stops"}),e.jsx("p",{className:"text-xs sm:text-sm text-gray-500 hidden sm:block",children:"Real-time transport info"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[n&&e.jsxs("p",{className:"text-xs text-gray-500 hidden sm:block",children:["Updated: ",n.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]}),e.jsxs("button",{onClick:a,disabled:d,className:"flex items-center gap-1 text-blue-600 hover:bg-blue-50 px-2 py-1.5 sm:px-3 sm:py-2 rounded-md transition-colors disabled:opacity-50 text-sm",children:[e.jsx(se,{className:`w-4 h-4 ${d?"animate-spin":""}`}),e.jsx("span",{className:"hidden sm:inline",children:"Refresh"})]})]})]})}),n&&e.jsxs("div",{className:"text-xs text-gray-500 text-center sm:hidden",children:["Updated: ",n.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]}),e.jsx(ae,{lat:t.lat,lon:t.lon}),e.jsx("div",{className:"space-y-4 sm:space-y-6",children:d?e.jsx(oe,{}):i?e.jsx("div",{className:"text-center bg-white border border-red-200 rounded-lg p-4 sm:p-6 shadow-sm",children:e.jsx("p",{className:"text-red-500 text-sm sm:text-base font-medium",children:i})}):o.length>0?e.jsx("div",{className:"grid gap-3 sm:gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3",children:o.map(s=>e.jsx(ie,{...s},`${s.stopId}-${s.city}`))}):e.jsx("div",{className:"text-center bg-white border border-gray-200 rounded-lg p-4 sm:p-6 shadow-sm",children:e.jsx("p",{className:"text-gray-500 text-sm sm:text-base font-medium",children:"No bus stops found"})})})]})}):e.jsx("div",{className:"text-center p-4",children:"Fetching your location..."})};function me(){return e.jsx(de,{})}const he=()=>window.location.pathname.includes("/local/city_dashboard/");function pe(){return window.location.pathname.includes("/local/city_dashboard/")}function ue(){if(pe()){console.log("Skipping Service Worker registration in Home Assistant");return}"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("https://transport.dzarlax.dev/service-worker.js").then(r=>{console.log("Service Worker registered with scope: ",r.scope)}).catch(r=>{console.warn("Service Worker registration skipped:",r)})})}Y.createRoot(document.getElementById("root")).render(e.jsx(K,{children:e.jsx(me,{})}));he()||ue();
