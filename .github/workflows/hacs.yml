name: HACS Action

on:
  push:
    branches:
      - main
  pull_request:
  schedule:
    - cron: "0 0 * * *"

jobs:
  hacs:
    name: HACS Validation
    runs-on: "ubuntu-latest"
    steps:
      - uses: "actions/checkout@v3"
      - name: HACS validation
        uses: "hacs/action@main"
        with:
          category: "integration"

  version-bump:
    name: Auto Version Bump & Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      # Сначала собираем фронтенд
      - name: Build frontend
        run: |
          HACS=true npm run build:hacs
          mkdir -p custom_components/city_dashboard/www
          cp -r www/community/city_dashboard/* custom_components/city_dashboard/www/

      # Затем готовим HACS-релиз
      - name: Prepare HACS package
        run: |
          mkdir -p hacs-release/custom_components/city_dashboard
          mkdir -p hacs-release/custom_components/city_dashboard/www
          mkdir -p hacs-release/custom_components/city_dashboard/translations
          
          # Копируем Python файлы
          cp custom_components/city_dashboard/__init__.py hacs-release/custom_components/city_dashboard/
          cp custom_components/city_dashboard/manifest.json hacs-release/custom_components/city_dashboard/
          cp custom_components/city_dashboard/config_flow.py hacs-release/custom_components/city_dashboard/
          cp custom_components/city_dashboard/const.py hacs-release/custom_components/city_dashboard/
          
          # Копируем переводы
          cp -r custom_components/city_dashboard/translations/* hacs-release/custom_components/city_dashboard/translations/
          
          # Копируем собранные файлы фронтенда
          cp -r custom_components/city_dashboard/www/* hacs-release/custom_components/city_dashboard/www/
          
          # Создаем архив
          cd hacs-release
          zip -r ../city_dashboard.zip ./*

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.version }}
          name: "Release v${{ env.version }}"
          body: "Automated release for HACS"
          draft: false
          prerelease: false
          files: |
            city_dashboard.zip